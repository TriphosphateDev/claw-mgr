<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Claw Mgr</title>
  <!-- build: remote-dropdowns -->
  <!-- __SERVED_FROM__ -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root { --mc-bg: #0d1117; --mc-card: #161b22; --mc-border: #30363d; --mc-text: #e6edf3; --mc-muted: #c9d1d9; }
    body { background: var(--mc-bg); color: var(--mc-text); font-size: 0.875rem; min-height: 100vh; }
    .mc-card { background: var(--mc-card); border: 1px solid var(--mc-border); border-radius: 6px; padding: 0.5rem 0.75rem; margin-bottom: 0.35rem; }
    .mc-card h6 { margin: 0 0 0.25rem 0; font-size: 0.75rem; font-weight: 600; color: #c9d1d9; text-transform: uppercase; letter-spacing: 0.02em; }
    .mc-list-item { padding: 0.25rem 0; border-bottom: 1px solid var(--mc-border); cursor: pointer; transition: background .15s; color: #e6edf3; }
    .mc-list-item:last-child { border-bottom: 0; }
    .mc-list-item:hover { background: rgba(255,255,255,.05); }
    .mc-list-item .small { color: #c9d1d9 !important; }
    .modal-content { background: var(--mc-card); border-color: var(--mc-border); color: var(--mc-text); }
    .modal-header, .modal-footer { border-color: var(--mc-border); }
    .modal-header .btn-close { filter: invert(1); }
    .form-select, .form-control { background: var(--mc-card); border-color: var(--mc-border); color: var(--mc-text); font-size: 0.875rem; }
    .form-select:focus, .form-control:focus { background: var(--mc-card); border-color: #58a6ff; color: var(--mc-text); box-shadow: 0 0 0 0.2rem rgba(88,166,255,.25); }
    .btn { font-size: 0.8125rem; padding: 0.25rem 0.5rem; }
    .btn-success { background: #238636; border-color: #238636; }
    .btn-danger { background: #da3633; border-color: #da3633; }
    .badge { font-size: 0.7rem; font-weight: 500; }
    pre { font-size: 0.75rem; background: #0d1117; padding: 0.5rem; border-radius: 4px; margin: 0; overflow-x: auto; }
    .status-dot { width: 6px; height: 6px; border-radius: 50%; display: inline-block; margin-right: 0.35rem; }
    .status-dot.ok { background: #3fb950; }
    .status-dot.err { background: #f85149; }
    .btn-outline-secondary { border-color: var(--mc-border); color: var(--mc-muted); }
    .btn-outline-secondary:hover { background: rgba(255,255,255,.08); border-color: var(--mc-border); color: var(--mc-text); }
    .accordion-item { background: var(--mc-card); border-color: var(--mc-border); }
    .accordion-button { background: #161b22; color: var(--mc-text); border-color: var(--mc-border); font-size: 0.875rem; padding: 0.4rem 0.75rem; }
    .accordion-button:not(.collapsed) { background: #21262d; color: var(--mc-text); box-shadow: none; }
    .accordion-button::after { filter: invert(1); }
    .accordion-button:focus { box-shadow: none; border-color: var(--mc-border); }
    .accordion-body { padding: 0.4rem 0.75rem; font-size: 0.8125rem; color: #c9d1d9; }
    .obj-row { padding: 0.2rem 0; border-bottom: 1px solid var(--mc-border); }
    .obj-row:last-child { border-bottom: 0; }
    .obj-key { color: #79c0ff; margin-right: 0.35rem; }
    #app .text-muted { color: #c9d1d9 !important; }
    #app .mc-card small { color: #c9d1d9 !important; }
  </style>
</head>
<body>
  <script>window.__OLLAMA_MODELS__ = []; window.__REMOTE_PROVIDERS__ = [];</script>
  <div id="app" class="container-fluid py-2 px-2 px-sm-3" style="max-width: 640px;">
    <h1 class="h5 mb-2 mt-1 fw-bold">Claw Mgr</h1>

    <div class="mc-card">
      <h6>Dashboard</h6>
      <div class="d-flex align-items-center justify-content-between gap-2 mb-1">
        <small class="text-muted">OpenClaw status snapshot</small>
        <div class="d-flex align-items-center gap-1">
          <button class="btn btn-outline-secondary btn-sm" @click="showDashboardRaw = !showDashboardRaw">{{ showDashboardRaw ? 'Hide raw' : 'Show raw' }}</button>
          <button class="btn btn-outline-secondary btn-sm" @click="refreshDashboard">Refresh</button>
        </div>
      </div>
      <div class="small mb-1" v-if="dashboardSummaryParsed">
        <div class="obj-row"><span class="obj-key">Gateway:</span>{{ dashboardSummaryParsed.gateway || '-' }}</div>
        <div class="obj-row"><span class="obj-key">Agents:</span>{{ dashboardSummaryParsed.agents || '-' }}</div>
        <div class="obj-row"><span class="obj-key">Sessions:</span>{{ dashboardSummaryParsed.sessions || '-' }}</div>
        <div class="obj-row"><span class="obj-key">Heartbeat:</span>{{ dashboardSummaryParsed.heartbeat || '-' }}</div>
        <div class="obj-row" v-if="dashboardSummaryParsed.security"><span class="obj-key">Security:</span>{{ dashboardSummaryParsed.security.critical }} critical · {{ dashboardSummaryParsed.security.warn }} warn · {{ dashboardSummaryParsed.security.info }} info</div>
      </div>
      <pre v-if="showDashboardRaw" style="max-height: 180px;">{{ dashboardSummaryRaw || 'No snapshot yet.' }}</pre>
    </div>

    <!-- Mode + Model + Start/Stop -->
    <div class="mc-card">
      <h6>Model</h6>
      <div class="d-flex flex-wrap align-items-center gap-1 mb-1">
        <div class="btn-group btn-group-sm" role="group">
          <button type="button" class="btn" :class="mode === 'local' ? 'btn-primary' : 'btn-outline-secondary'" @click="mode = 'local'">Local</button>
          <button type="button" class="btn" :class="mode === 'remote' ? 'btn-primary' : 'btn-outline-secondary'" @click="mode = 'remote'">Remote</button>
        </div>
        <select v-model="selectedModel" v-show="mode === 'local'" class="form-select form-select-sm" style="max-width: 200px;">
          <option value="">— select Ollama —</option>
          <option v-for="m in ollamaModels" :key="m.id" :value="m.id">{{ m.name }}</option>
        </select>
        <div v-show="mode === 'remote'" class="d-inline-flex flex-wrap align-items-center gap-1">
          <select v-model="remoteProvider" @change="onRemoteProviderChange" class="form-select form-select-sm" style="min-width: 130px; max-width: 160px;" title="Choose API provider">
            <option value="">— provider —</option>
            <option v-for="p in remoteProviders" :key="p.id" :value="p.id">{{ p.label }}</option>
            <option v-if="remoteProviders.length === 0" value="" disabled>Loading…</option>
          </select>
          <select v-if="remoteProvider && remoteProvider !== 'other'" v-model="remoteModel" @change="saveRemoteConfig" class="form-select form-select-sm" style="min-width: 160px; max-width: 220px;">
            <option value="">— model —</option>
            <option v-for="m in currentRemoteProviderModels" :key="modelId(m)" :value="modelId(m)">{{ modelLabel(m) }}</option>
          </select>
          <input v-if="remoteProvider === 'other'" v-model="remoteCustomModel" @input="saveRemoteConfig" type="text" class="form-control form-control-sm" style="min-width: 120px; max-width: 180px;" placeholder="provider/model" />
        </div>
        <button class="btn btn-success btn-sm" :disabled="!canStart || state.running.gateway" @click="start">Start</button>
        <button class="btn btn-danger btn-sm" :disabled="!state.running.gateway && !state.running.dashboard" @click="stop">Stop</button>
      </div>
      <small class="text-muted" v-if="!state.running.gateway">Saved: {{ mode }} · {{ state.model || config[mode]?.model || '—' }}</small>
      <small class="text-muted" v-if="state.running.gateway">Running · {{ state.mode || mode }} · {{ state.model || '—' }}</small>
    </div>

    <!-- Remote API options (only when Remote mode) -->
    <div class="mc-card" v-show="mode === 'remote'">
      <h6>Remote API</h6>
      <div class="row g-1 mb-1">
        <div class="col-12 col-sm-6">
          <label class="form-label small mb-0 text-muted">Provider</label>
          <select v-model="remoteProvider" @change="onRemoteProviderChange" class="form-select form-select-sm">
            <option value="">— select —</option>
            <option v-for="p in remoteProviders" :key="p.id" :value="p.id">{{ p.label }}</option>
          </select>
        </div>
        <div class="col-12 col-sm-6" v-if="remoteProvider && remoteProvider !== 'other'">
          <label class="form-label small mb-0 text-muted">Model</label>
          <select v-model="remoteModel" @change="saveRemoteConfig" class="form-select form-select-sm">
            <option value="">— select —</option>
            <option v-for="m in currentRemoteProviderModels" :key="modelId(m)" :value="modelId(m)">{{ modelLabel(m) }}</option>
          </select>
        </div>
        <div class="col-12 col-sm-6" v-if="remoteProvider === 'other'">
          <label class="form-label small mb-0 text-muted">Model (provider/id)</label>
          <input v-model="remoteCustomModel" @input="saveRemoteConfig" type="text" class="form-control form-control-sm" placeholder="e.g. custom/gpt-4o" />
        </div>
        <div class="col-12 col-sm-6" v-if="remoteProvider === 'other'">
          <label class="form-label small mb-0 text-muted">API key env var (optional)</label>
          <input v-model="remoteCustomEnvKey" @input="saveRemoteConfig" type="text" class="form-control form-control-sm" placeholder="e.g. CUSTOM_API_KEY" />
        </div>
      </div>
      <div class="row g-1 mb-1">
        <div class="col-12 col-sm-6">
          <label class="form-label small mb-0 text-muted">API key (optional — use env if blank)</label>
          <input v-model="remoteApiKey" type="password" class="form-control form-control-sm" placeholder="Leave blank to use ~/.openclaw/.env" autocomplete="off" />
        </div>
        <div class="col-12 col-sm-6">
          <label class="form-label small mb-0 text-muted">Base URL (optional)</label>
          <input v-model="remoteBaseUrl" @input="saveRemoteConfig" type="text" class="form-control form-control-sm" placeholder="https://api.example.com/v1" />
        </div>
      </div>
      <small class="text-muted" v-if="currentRemoteEnvKey">Env key: {{ currentRemoteEnvKey }}</small>
    </div>

    <!-- Heartbeat -->
    <div class="mc-card">
      <h6>Heartbeat</h6>
      <div class="d-flex align-items-center flex-wrap gap-2">
        <span><span class="status-dot" :class="heartbeat.gateway?.ok ? 'ok' : 'err'"></span>Gateway {{ heartbeat.gateway?.ok ? 'up' : 'down' }}</span>
        <span v-if="heartbeat.state?.lastHeartbeatAt" class="text-muted">Last {{ formatAgo(heartbeat.state.lastHeartbeatAt) }}</span>
      </div>
    </div>

    <!-- Activity -->
    <div class="mc-card">
      <h6>Activity</h6>
      <div v-if="activity.length === 0" class="small text-muted py-1">No activity</div>
      <div v-else>
        <div v-for="(a, i) in activity" :key="i" class="mc-list-item" @click="openActivity(a)">
          <span class="small text-muted">{{ a.date }}</span> {{ a.description | truncate(60) }}
        </div>
      </div>
    </div>

    <!-- Cron jobs -->
    <div class="mc-card">
      <h6>Cron jobs</h6>
      <div v-if="cronJobs.length === 0" class="small text-muted py-1">None</div>
      <div v-else>
        <div v-for="j in cronJobs" :key="j.jobId || j.name" class="mc-list-item d-flex justify-content-between align-items-center">
          <span @click="openCron(j)" style="cursor:pointer;">{{ j.name }}</span>
          <div class="d-flex align-items-center gap-1">
            <button class="btn btn-outline-secondary btn-sm" @click="openCronRuns(j)">Runs</button>
            <button class="btn btn-outline-secondary btn-sm" @click="runCronJob(j)">Run</button>
            <span class="badge" :class="j.enabled ? 'bg-success' : 'bg-secondary'">{{ j.enabled ? 'on' : 'off' }}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Activity detail modal (inside #app so Vue compiles it) -->
    <div class="modal fade" id="activityModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header py-2">
            <h6 class="modal-title">{{ detailActivity.date }}</h6>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body py-2">
            <p class="mb-1">{{ detailActivity.description }}</p>
            <small class="text-muted">File: {{ detailActivity.file }}</small>
          </div>
        </div>
      </div>
    </div>

    <!-- Cron detail modal (inside #app so Vue compiles it) -->
    <div class="modal fade" id="cronModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header py-2">
            <h6 class="modal-title">{{ detailCron.name || 'Cron job' }}</h6>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body py-2">
            <div class="accordion" v-if="detailCron.schedule || detailCron.payload">
              <div class="accordion-item" v-if="detailCron.schedule">
                <h2 class="accordion-header">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#cronDetailSchedule">Schedule</button>
                </h2>
                <div id="cronDetailSchedule" class="accordion-collapse collapse">
                  <div class="accordion-body py-1">
                    <json-accordion :data="detailCron.schedule" id-prefix="cron-schedule"></json-accordion>
                  </div>
                </div>
              </div>
              <div class="accordion-item" v-if="detailCron.payload">
                <h2 class="accordion-header">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#cronDetailPayload">Payload</button>
                </h2>
                <div id="cronDetailPayload" class="accordion-collapse collapse">
                  <div class="accordion-body py-1">
                    <json-accordion :data="detailCron.payload" id-prefix="cron-payload"></json-accordion>
                  </div>
                </div>
              </div>
            </div>
            <p class="mb-1 mt-2" v-if="detailCron.sessionTarget"><strong>Target</strong> {{ detailCron.sessionTarget }}</p>
            <span class="badge" :class="detailCron.enabled !== false ? 'bg-success' : 'bg-secondary'">{{ detailCron.enabled !== false ? 'enabled' : 'disabled' }}</span>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="cronRunsModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
          <div class="modal-header py-2">
            <h6 class="modal-title">Runs · {{ detailCron.name || detailCron.jobId }}</h6>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body py-2">
            <div v-if="cronRuns.length === 0" class="small text-muted">No runs found.</div>
            <div v-for="(r, idx) in cronRuns" :key="idx" class="mc-card mb-1">
              <div class="d-flex align-items-center justify-content-between">
                <strong>{{ r.status || r.action || 'run' }}</strong>
                <small class="text-muted">{{ r.ts ? new Date(r.ts).toLocaleString() : 'unknown time' }}</small>
              </div>
              <pre>{{ JSON.stringify(r, null, 2) }}</pre>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/vendor/vue.global.prod.js"></script>
  <script>
    Vue.config.productionTip = false;
    Vue.filter('truncate', function (v, len) {
      if (!v) return '';
      return v.length <= len ? v : v.slice(0, len) + '…';
    });

    Vue.component('json-accordion', {
      name: 'JsonAccordion',
      props: { data: { type: Object, default: null }, idPrefix: { type: String, default: 'obj' } },
      template: '<div class="accordion" v-if="data">' +
        '<div class="accordion-item" v-for="(value, key) in data" :key="key">' +
          '<h2 class="accordion-header">' +
            '<button class="accordion-button collapsed" type="button" :data-bs-toggle="\'collapse\'" :data-bs-target="\'#\' + safeId(key)" aria-expanded="false">' +
              '{{ key }}' +
            '</button>' +
          '</h2>' +
          '<div :id="safeId(key)" class="accordion-collapse collapse">' +
            '<div class="accordion-body py-1">' +
              '<template v-if="isObject(value)">' +
                '<json-accordion :data="value" :id-prefix="idPrefix + \'-\' + safeId(key)"></json-accordion>' +
              '</template>' +
              '<template v-else-if="Array.isArray(value)">' +
                '<ul class="list-unstyled mb-0 small"><li v-for="(item, i) in value" :key="i" class="obj-row"><span class="obj-key">{{ i }}:</span> {{ item }}</li></ul>' +
              '</template>' +
              '<div v-else class="obj-row">{{ value }}</div>' +
            '</div>' +
          '</div>' +
        '</div>' +
      '</div>',
      methods: {
        safeId(key) {
          return this.idPrefix + '-' + String(key).replace(/[^a-z0-9-_]/gi, '-');
        },
        isObject(v) {
          return v !== null && typeof v === 'object' && !Array.isArray(v);
        }
      }
    });

    new Vue({
      el: '#app',
      data: {
        mode: 'local',
        selectedModel: '',
        ollamaModels: [],
        config: { mode: 'local', local: {}, remote: {} },
        state: { gatewayPid: null, dashboardPid: null, model: null, mode: null, running: { gateway: false, dashboard: false } },
        activity: [],
        cronJobs: [],
        heartbeat: { gateway: {}, state: {} },
        dashboardSummaryRaw: '',
        dashboardSummaryParsed: null,
        showDashboardRaw: false,
        cronRuns: [],
        detailActivity: {},
        detailCron: {},
        activityModal: null,
        cronModal: null,
        cronRunsModal: null,
        remoteProviders: (typeof window !== 'undefined' && window.__REMOTE_PROVIDERS__) ? window.__REMOTE_PROVIDERS__ : [],
        remoteProvider: '',
        remoteModel: '',
        remoteCustomModel: '',
        remoteApiKey: '',
        remoteBaseUrl: '',
        remoteCustomEnvKey: '',
      },
      computed: {
        currentRemoteProviderModels() {
          const p = this.remoteProviders.find((x) => x.id === this.remoteProvider);
          return p && p.models ? p.models : [];
        },
        currentRemoteEnvKey() {
          if (this.remoteProvider === 'other') return this.remoteCustomEnvKey || this.config.remote?.apiKeyEnv || '';
          const p = this.remoteProviders.find((x) => x.id === this.remoteProvider);
          return p && p.envKey ? p.envKey : '';
        },
        displayRemoteModel() {
          return this.effectiveRemoteModel || '—';
        },
        effectiveRemoteModel() {
          if (this.remoteProvider === 'other') return this.remoteCustomModel || this.config.remote?.model || '';
          if (this.remoteProvider && this.remoteModel) return this.remoteProvider + '/' + this.remoteModel;
          return this.config.remote?.model || '';
        },
      },
      mounted() {
        if (window.__OLLAMA_MODELS__ && window.__OLLAMA_MODELS__.length) {
          this.ollamaModels = window.__OLLAMA_MODELS__;
          if (!this.selectedModel) this.selectedModel = this.ollamaModels[0].id;
        }
        this.activityModal = new bootstrap.Modal(document.getElementById('activityModal'));
        this.cronModal = new bootstrap.Modal(document.getElementById('cronModal'));
        this.cronRunsModal = new bootstrap.Modal(document.getElementById('cronRunsModal'));
        this.refresh();
        setInterval(this.refresh, 25000);
      },
      methods: {
        formatAgo(ts) {
          const s = Math.floor((Date.now() - ts) / 1000);
          if (s < 60) return 'just now';
          if (s < 3600) return Math.floor(s / 60) + 'm ago';
          if (s < 86400) return Math.floor(s / 3600) + 'h ago';
          return Math.floor(s / 86400) + 'd ago';
        },
        async refresh() {
          try {
            const [stateRes, activityRes, cronRes, heartbeatRes, dashboardRes, configRes, providersRes] = await Promise.all([
              fetch('/api/state'),
              fetch('/api/activity'),
              fetch('/api/cron'),
              fetch('/api/heartbeat'),
              fetch('/api/dashboard/summary').catch(() => ({ ok: false })),
              fetch('/api/config').catch(() => ({ ok: false })),
              fetch('/api/remote-providers').catch(() => ({ ok: false })),
            ]);
            if (stateRes.ok) this.state = await stateRes.json();
            if (activityRes.ok) this.activity = await activityRes.json();
            if (cronRes.ok) this.cronJobs = (await cronRes.json()).jobs || [];
            if (heartbeatRes.ok) this.heartbeat = await heartbeatRes.json();
            if (dashboardRes.ok) {
              const dash = await dashboardRes.json();
              this.dashboardSummaryRaw = dash?.data?.raw || '';
              this.dashboardSummaryParsed = dash?.data?.parsed || null;
            }
            if (providersRes.ok) {
              const data = await providersRes.json();
              this.remoteProviders = data.providers || [];
            }
            if (configRes.ok) {
              const cfg = await configRes.json();
              this.config = cfg;
              if (cfg.mode) this.mode = cfg.mode;
              if (cfg.local?.model) this.selectedModel = this.selectedModel || cfg.local.model;
              if (cfg.remote) {
                this.remoteProvider = cfg.remote.provider || '';
                this.remoteBaseUrl = cfg.remote.baseUrl || '';
                this.remoteCustomEnvKey = cfg.remote.apiKeyEnv || '';
                if (cfg.remote.model) {
                  const slash = cfg.remote.model.indexOf('/');
                  if (slash > 0) {
                    const prov = cfg.remote.model.slice(0, slash);
                    const modelId = cfg.remote.model.slice(slash + 1);
                    if (prov === 'other' || !this.remoteProviders.find((p) => p.id === prov)) {
                      this.remoteProvider = 'other';
                      this.remoteCustomModel = cfg.remote.model;
                    } else {
                      this.remoteProvider = prov;
                      this.remoteModel = modelId;
                    }
                  } else {
                    this.remoteCustomModel = cfg.remote.model;
                  }
                }
              }
            }
            const modelsRes = await fetch('/api/ollama-models');
            if (modelsRes.ok) {
              const data = await modelsRes.json();
              this.ollamaModels = data.models || [];
              if (!this.selectedModel && this.ollamaModels.length) this.selectedModel = this.ollamaModels[0].id;
            } else if (this.ollamaModels.length === 0 && window.__OLLAMA_MODELS__) {
              this.ollamaModels = window.__OLLAMA_MODELS__;
            }
          } catch (e) {}
        },
        canStart() {
          if (this.mode === 'local') return !!this.selectedModel;
          return !!this.effectiveRemoteModel;
        },
        modelId(m) {
          return typeof m === 'object' && m && m.id != null ? m.id : m;
        },
        modelLabel(m) {
          if (typeof m === 'object' && m && m.id != null) {
            return m.ctx ? m.id + ' · ' + m.ctx : m.id;
          }
          return String(m);
        },
        onRemoteProviderChange() {
          this.remoteModel = '';
          this.remoteCustomModel = '';
          this.saveRemoteConfig();
        },
        saveRemoteConfig() {
          const model = this.effectiveRemoteModel;
          const remote = {
            provider: this.remoteProvider || undefined,
            model: model || undefined,
            baseUrl: this.remoteBaseUrl.trim() || undefined,
            apiKeyEnv: this.remoteProvider === 'other' ? (this.remoteCustomEnvKey.trim() || undefined) : undefined,
          };
          fetch('/api/config', {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ mode: 'remote', remote }),
          }).then((r) => r.ok && r.json().then((c) => { this.config = c; }));
        },
        async start() {
          if (!this.canStart()) return;
          try {
            await fetch('/api/config', {
              method: 'PATCH',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                mode: this.mode,
                localModel: this.mode === 'local' ? this.selectedModel : undefined,
                ...(this.mode === 'remote' ? { remote: { provider: this.remoteProvider, model: this.effectiveRemoteModel, baseUrl: this.remoteBaseUrl.trim() || undefined, apiKeyEnv: this.remoteProvider === 'other' ? (this.remoteCustomEnvKey.trim() || undefined) : undefined } } : {}),
              }),
            });
            const model = this.mode === 'local' ? this.selectedModel : this.effectiveRemoteModel;
            const res = await fetch('/api/start', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                mode: this.mode,
                model,
                ...(this.mode === 'remote' && this.remoteApiKey.trim() ? { remoteApiKey: this.remoteApiKey.trim() } : {}),
              }),
            });
            const data = await res.json();
            if (data.error) alert(data.error);
            else this.refresh();
          } catch (e) {
            alert(e.message);
          }
        },
        async stop() {
          try {
            await fetch('/api/stop', { method: 'POST' });
            this.refresh();
          } catch (e) {
            alert(e.message);
          }
        },
        openActivity(a) {
          this.detailActivity = a;
          this.activityModal.show();
        },
        async refreshDashboard() {
          try {
            const res = await fetch('/api/dashboard/summary');
            if (res.ok) {
              const data = await res.json();
              this.dashboardSummaryRaw = data?.data?.raw || '';
              this.dashboardSummaryParsed = data?.data?.parsed || null;
            }
          } catch (e) {}
        },
        async runCronJob(j) {
          if (!confirm('Run cron job now?\n\n' + (j.name || j.jobId))) return;
          try {
            const res = await fetch('/api/cron/' + encodeURIComponent(j.jobId) + '/run', { method: 'POST' });
            const data = await res.json();
            if (!res.ok || !data.ok) alert(data?.data?.stderr || data?.error?.message || 'Cron run failed');
            await this.refresh();
          } catch (e) {
            alert(e.message);
          }
        },
        async openCronRuns(j) {
          this.detailCron = j;
          this.cronRuns = [];
          try {
            const res = await fetch('/api/cron/' + encodeURIComponent(j.jobId) + '/runs?limit=20');
            if (res.ok) {
              const data = await res.json();
              this.cronRuns = data?.data?.runs || [];
            }
          } catch (e) {}
          this.cronRunsModal.show();
        },
        openCron(j) {
          this.detailCron = j;
          this.cronModal.show();
        },
      },
    });
  </script>
</body>
</html>
